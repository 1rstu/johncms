#!/usr/bin/env php
<?php

/**
 * This file is part of JohnCMS Content Management System.
 *
 * @copyright JohnCMS Community
 * @license   https://opensource.org/licenses/GPL-3.0 GPL-3.0
 * @link      https://johncms.com JohnCMS Project
 */

chdir(dirname(__DIR__, 2));

if (is_file($a = 'system/vendor/autoload.php') === true) {
    require $a;
} else {
    exit('ERROR: autoload.php not found');
}

use Gettext\Scanner\PhpScanner;
use Gettext\Generator\PoGenerator;
use Gettext\Translations;

$domainSearch = [
        'admin' => [
                'target'   => 'modules/admin/locale',
                'scan_dir' => [
                        'modules/admin',
                ]
        ],

        'album' => [
                'target'   => 'modules/album/locale',
                'scan_dir' => [
                        'modules/album',
                ]
        ],

        'community' => [
                'target'   => 'modules/community/locale',
                'scan_dir' => [
                        'modules/community',
                ]
        ],

        'downloads' => [
                'target'   => 'modules/downloads/locale',
                'scan_dir' => [
                        'modules/downloads',
                ]
        ],

        'forum' => [
                'target'   => 'modules/forum/locale',
                'scan_dir' => [
                        'modules/forum',
                ]
        ],

        'guestbook' => [
                'target'   => 'modules/guestbook/locale',
                'scan_dir' => [
                        'modules/guestbook',
                ]
        ],

        'help' => [
                'target'   => 'modules/help/locale',
                'scan_dir' => [
                        'modules/help',
                ]
        ],

        'homepage' => [
                'target'   => 'modules/homepage/locale',
                'scan_dir' => [
                        'modules/homepage',
                ]
        ],

        'library' => [
                'target'   => 'modules/library/locale',
                'scan_dir' => [
                        'modules/library',
                ]
        ],

        'mail' => [
                'target'   => 'modules/mail/locale',
                'scan_dir' => [
                        'modules/mail',
                ]
        ],

        'news' => [
                'target'   => 'modules/news/locale',
                'scan_dir' => [
                        'modules/news',
                ]
        ],

        'online' => [
                'target'   => 'modules/online/locale',
                'scan_dir' => [
                        'modules/online',
                ]
        ],

        'profile' => [
                'target'   => 'modules/profile/locale',
                'scan_dir' => [
                        'modules/profile',
                ]
        ],

        'registration' => [
                'target'   => 'modules/registration/locale',
                'scan_dir' => [
                        'modules/registration',
                ]
        ],

        'notifications' => [
                'target'   => 'modules/notifications/locale',
                'scan_dir' => [
                        'modules/notifications',
                ]
        ],

        'system' => [
                'target'     => 'system/locale',
                'scan_dir'   => [
                        'modules/language',
                        'modules/login',
                        'modules/notifications',
                        'modules/redirect',
                        'system/src',
                        'themes/default/templates',
                ],
                'scan_files' => [
                        'system/helpers.php',
                ],
        ],
];

function recursiveScan($folder, $pattern)
{
    $dir = new RecursiveDirectoryIterator($folder);
    $ite = new RecursiveIteratorIterator($dir);
    $files = new RegexIterator($ite, $pattern, RegexIterator::GET_MATCH);
    $fileList = [];

    foreach ($files as $file) {
        $fileList[] = str_replace('\\', '/', $file[0]);
    }

    return $fileList;
}

foreach ($domainSearch as $domain => $attributes) {
    $list = [];
    foreach ($attributes['scan_dir'] as $dir) {
        $list = array_merge($list, recursiveScan($dir, '/^.+\.(?:phtml|php)$/i'));
    }

    if (isset($attributes['scan_files'])) {
        foreach ($attributes['scan_files'] as $fileToScan) {
            $list[] = $fileToScan;
        }
    }

    $phpScanner = new PhpScanner(Translations::create($domain));
    $phpScanner->setDefaultDomain($domain);
    $phpScanner->setFunctions(['__' => 'gettext', 'd__' => 'dgettext', 'n__' => 'ngettext', 'dn__' => 'dngettext']);

    sort($list, SORT_STRING);
    foreach ($list as $file) {
        $phpScanner->scanFile($file);
    }

    $generator = new PoGenerator();
    $generator->generateFile($phpScanner->getTranslations()[$domain], $attributes['target'] . '/' . $domain . '.pot');
}

exit('[32mLanguage templates has been created successfully[0m' . "\n");
